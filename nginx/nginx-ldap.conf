# NGINX Konfiguration mit Active Directory LDAPS Authentifizierung
# 
# VORAUSSETZUNG: NGINX mit nginx-auth-ldap Modul kompiliert
# Installation: https://github.com/kvspb/nginx-auth-ldap
#
# Alternativ: nginx-full Paket unter Ubuntu

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # LDAP Server Konfiguration
    ldap_server firma_ad {
        # LDAPS Verbindung (SSL/TLS)
        url ldaps://dc.firma.local:636/DC=firma,DC=local?sAMAccountName?sub?(objectClass=person);
        
        # Service Account für LDAP Bind
        # WICHTIG: In Production durch echte Credentials ersetzen!
        binddn "CN=nginx_service,OU=ServiceAccounts,DC=firma,DC=local";
        binddn_passwd "SERVICE_ACCOUNT_PASSWORD";
        
        # Group Filter (optional - nur bestimmte Gruppe erlauben)
        # group_attribute member;
        # group_attribute_is_dn on;
        # require group "CN=WebApp-Users,OU=Groups,DC=firma,DC=local";
        
        # Require gültigen AD User
        require valid_user;
        
        # SSL Optionen
        ssl_check_cert off;  # In Production: on (mit CA-Zertifikat)
        # ssl_ca_file /etc/nginx/ssl/ad-ca.crt;
        
        # Timeouts
        connect_timeout 5s;
        bind_timeout 5s;
        request_timeout 5s;
    }
    
    # WebAssembly MIME Type
    types {
        application/wasm wasm;
    }
    
    # Gzip
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/wasm;
    
    server {
        listen 443 ssl;
        server_name webapp.firma.local;
        
        # SSL Zertifikate
        # In Production: Echte Zertifikate verwenden!
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        
        # SSL Konfiguration
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        
        # Frontend (WebAssembly) - MIT Authentifizierung
        location / {
            # LDAP Authentifizierung
            auth_ldap "Active Directory Login";
            auth_ldap_servers firma_ad;
            
            root /usr/share/nginx/html;
            index frontend.html;
            try_files $uri $uri/ /frontend.html;
            
            # WebAssembly Headers
            add_header Cross-Origin-Opener-Policy same-origin;
            add_header Cross-Origin-Embedder-Policy require-corp;
            
            # Username an Frontend übergeben (optional)
            add_header X-Authenticated-User $remote_user;
        }
        
        # Backend API - MIT Authentifizierung
        location /api/ {
            # LDAP Authentifizierung
            auth_ldap "Active Directory Login";
            auth_ldap_servers firma_ad;
            
            # Proxy zu Qt Backend
            proxy_pass http://host.docker.internal:8080;
            
            # Headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            
            # Authenticated User an Backend
            proxy_set_header X-Authenticated-User $remote_user;
            
            # CORS
            add_header Access-Control-Allow-Origin https://webapp.firma.local;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
            add_header Access-Control-Allow-Headers "Content-Type, Authorization";
            add_header Access-Control-Allow-Credentials true;
        }
        
        # Health Check - OHNE Authentifizierung
        location /health {
            auth_ldap off;
            proxy_pass http://host.docker.internal:8080/health;
            access_log off;
        }
    }
    
    # HTTP zu HTTPS Redirect
    server {
        listen 80;
        server_name webapp.firma.local;
        return 301 https://$server_name$request_uri;
    }
}
