# NGINX Konfiguration mit Microsoft 365 / Azure AD OAuth
#
# VORAUSSETZUNG: 
# - NGINX mit OpenResty oder lua-nginx-module
# - lua-resty-openidc Bibliothek
#
# AZURE AD APP REGISTRIERUNG:
# 1. Azure Portal → App registrations → New registration
# 2. Name: "WebApp"
# 3. Redirect URI: https://webapp.firma.local/redirect_uri
# 4. Nach Erstellung: Client ID und Secret notieren
# 5. API permissions → Microsoft Graph → User.Read
# 6. Grant admin consent
#
# INSTALLATION OpenResty:
# Ubuntu: apt-get install openresty
# RHEL: yum install openresty
#
# lua-resty-openidc:
# opm install zmartzone/lua-resty-openidc

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Lua Package Path
    lua_package_path "/usr/local/openresty/lualib/?.lua;;";
    lua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
    lua_ssl_verify_depth 2;
    
    # Session Storage für OAuth Tokens
    lua_shared_dict discovery 1m;
    lua_shared_dict jwks 1m;
    lua_shared_dict introspection 10m;
    
    # Gzip
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/wasm;
    
    # WebAssembly MIME Type
    types {
        application/wasm wasm;
    }
    
    server {
        listen 443 ssl;
        server_name webapp.firma.local;
        
        # SSL
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        
        # Session Cookie Secret (64 Zeichen zufällig generieren!)
        set $session_secret 'CHANGE_ME_TO_RANDOM_64_CHAR_STRING_aAbBcCdDeEfF1122334455';
        
        # OAuth Protected Locations
        location / {
            access_by_lua_block {
                local opts = {
                    -- Azure AD Endpoints
                    discovery = "https://login.microsoftonline.com/TENANT_ID/v2.0/.well-known/openid-configuration",
                    
                    -- App Registration Details
                    -- WICHTIG: Durch echte Werte ersetzen!
                    client_id = "YOUR_CLIENT_ID",
                    client_secret = "YOUR_CLIENT_SECRET",
                    
                    -- Redirect URI (muss mit Azure AD App übereinstimmen)
                    redirect_uri = "https://webapp.firma.local/redirect_uri",
                    
                    -- OAuth Scopes
                    scope = "openid email profile",
                    
                    -- Token Validation
                    iat_slack = 600,
                    
                    -- Session
                    session_contents = {id_token=true, user=true},
                    
                    -- Logout
                    logout_path = "/logout",
                    redirect_after_logout_uri = "https://webapp.firma.local/",
                }
                
                local res, err = require("resty.openidc").authenticate(opts)
                
                if err then
                    ngx.status = 500
                    ngx.say("Authentication error: ", err)
                    ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
                end
                
                -- User Info in Header setzen
                ngx.req.set_header("X-Authenticated-User", res.id_token.preferred_username or res.id_token.email)
                ngx.req.set_header("X-User-Email", res.id_token.email)
                ngx.req.set_header("X-User-Name", res.id_token.name)
            }
            
            root /usr/share/nginx/html;
            index frontend.html;
            try_files $uri $uri/ /frontend.html;
            
            # WebAssembly Headers
            add_header Cross-Origin-Opener-Policy same-origin;
            add_header Cross-Origin-Embedder-Policy require-corp;
        }
        
        # Redirect URI für OAuth Callback
        location /redirect_uri {
            access_by_lua_block {
                local opts = {
                    discovery = "https://login.microsoftonline.com/TENANT_ID/v2.0/.well-known/openid-configuration",
                    client_id = "YOUR_CLIENT_ID",
                    client_secret = "YOUR_CLIENT_SECRET",
                    redirect_uri = "https://webapp.firma.local/redirect_uri",
                    scope = "openid email profile",
                }
                
                require("resty.openidc").authenticate(opts)
            }
        }
        
        # Logout Handler
        location /logout {
            access_by_lua_block {
                local opts = {
                    discovery = "https://login.microsoftonline.com/TENANT_ID/v2.0/.well-known/openid-configuration",
                    client_id = "YOUR_CLIENT_ID",
                    client_secret = "YOUR_CLIENT_SECRET",
                    redirect_uri = "https://webapp.firma.local/redirect_uri",
                    redirect_after_logout_uri = "https://webapp.firma.local/",
                }
                
                require("resty.openidc").authenticate(opts)
            }
        }
        
        # Backend API mit OAuth
        location /api/ {
            access_by_lua_block {
                local opts = {
                    discovery = "https://login.microsoftonline.com/TENANT_ID/v2.0/.well-known/openid-configuration",
                    client_id = "YOUR_CLIENT_ID",
                    client_secret = "YOUR_CLIENT_SECRET",
                    redirect_uri = "https://webapp.firma.local/redirect_uri",
                    scope = "openid email profile",
                }
                
                local res, err = require("resty.openidc").authenticate(opts)
                
                if err then
                    ngx.status = 401
                    ngx.say("Unauthorized: ", err)
                    ngx.exit(ngx.HTTP_UNAUTHORIZED)
                end
                
                -- User Info an Backend
                ngx.req.set_header("X-Authenticated-User", res.id_token.preferred_username or res.id_token.email)
                ngx.req.set_header("X-User-Email", res.id_token.email)
            }
            
            proxy_pass http://host.docker.internal:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }
        
        # Health Check ohne Auth
        location /health {
            proxy_pass http://host.docker.internal:8080/health;
            access_log off;
        }
    }
    
    # HTTP zu HTTPS Redirect
    server {
        listen 80;
        server_name webapp.firma.local;
        return 301 https://$server_name$request_uri;
    }
}

# SETUP ANLEITUNG:
#
# 1. Azure AD App registrieren (siehe oben)
#
# 2. Tenant ID ermitteln:
#    Azure Portal → Azure Active Directory → Overview → Tenant ID
#
# 3. In dieser Config ersetzen:
#    - TENANT_ID → Ihre Azure Tenant ID
#    - YOUR_CLIENT_ID → Client ID aus App Registration
#    - YOUR_CLIENT_SECRET → Client Secret aus App Registration
#    - session_secret → Zufälligen 64-Zeichen String generieren
#
# 4. OpenResty installieren:
#    Ubuntu: apt-get install openresty
#
# 5. lua-resty-openidc installieren:
#    opm install zmartzone/lua-resty-openidc
#
# 6. SSL Zertifikat für webapp.firma.local
#
# 7. NGINX neu starten:
#    systemctl restart openresty
#
# TESTING:
# - Browser: https://webapp.firma.local
# - Wird zu Microsoft Login umgeleitet
# - Nach Login: Zurück zu Ihrer App
# - User Info in X-Authenticated-User Header
#
# FRONTEND LOGOUT BUTTON:
# <Button onClicked: window.location.href = "/logout">Logout</Button>
